<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulación: Trazabilidad de Productos</title>
    
    <!-- Dependencias de Leaflet.js (Mapa) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Space+Grotesk:wght@500;700&display=swap');

        :root {
            --bg-color: #111827;
            --surface-color: #1f2937;
            --border-color: #374151;
            --text-color: #d1d5db;
            --accent-color: #3b82f6;
            --completed-color: #22c55e;
            --active-color: #f59e0b;
            --inactive-color: #6b7280;
        }

        body, html {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100%;
            margin: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            box-sizing: border-box;
        }

        .simulation-container {
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            width: 100%;
            max-width: 1200px;
            height: 95%;
            max-height: 800px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        h1 {
            margin: 0;
            color: #fff;
            font-family: 'Space Grotesk', sans-serif;
            text-align: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .main-content {
            flex-grow: 1;
            display: flex;
            gap: 1.5rem;
            min-height: 0;
        }
        
        #map {
            flex: 2;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: #0d1117;
            min-height: 300px;
        }
        .leaflet-tile-pane {
            filter: invert(1) hue-rotate(180deg) brightness(0.9) contrast(0.9);
        }

        .truck-icon {
            width: 32px;
            height: 32px;
            background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="%23f59e0b" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"%3E%3Cpath d="M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2"/%3E%3Cpath d="M15 18H9"/%3E%3Cpath d="M19 18h2a1 1 0 0 0 1-1v-3a1 1 0 0 0-1-1h-1v-4a1 1 0 0 0-1-1h-4V5a1 1 0 0 0-1-1H3a1 1 0 0 0-1 1v4"/%3E%3Cpath d="M7 18v-6h6v6"/%3E%3Ccircle cx="7" cy="18" r="2"/%3E%3Ccircle cx="17" cy="18" r="2"/%3E%3C/svg%3E');
            background-size: contain;
        }

        .info-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            min-width: 280px;
            min-height: 0;
        }

        .info-card { background-color: #111827; border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; }
        .info-card h3 { margin: 0 0 0.75rem 0; font-size: 1.1rem; }
        .info-item { display: flex; justify-content: space-between; padding: 0.4rem 0; font-size: 0.9rem; }
        .info-item label { color: #9ca3af; }
        .info-item span { font-weight: 700; }

        .status-history { flex-grow: 1; min-height: 0; overflow-y: auto; }
        .status-item { display: flex; align-items: flex-start; margin-bottom: 0.75rem; gap: 0.75rem; }
        .status-icon { width: 16px; height: 16px; border-radius: 50%; background-color: var(--inactive-color); flex-shrink: 0; margin-top: 2px; }
        .status-icon.active { background-color: var(--active-color); box-shadow: 0 0 8px var(--active-color); }
        .status-icon.completed { background-color: var(--completed-color); }
        .status-details p { margin: 0; font-weight: 500; }
        .status-details small { color: #9ca3af; font-size: 0.8rem; }

        .status-history::-webkit-scrollbar { width: 6px; }
        .status-history::-webkit-scrollbar-track { background: transparent; }
        .status-history::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }

        .controls { display: flex; justify-content: center; gap: 1rem; flex-shrink: 0; }
        .controls button { background-color: var(--accent-color); color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 8px; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; }
        .controls button:hover { opacity: 0.8; }
        .controls button:active { transform: scale(0.95); }
        .controls button#stop-btn { background-color: #d97706; }
        .controls button#reset-btn { background-color: #6b7280; }

        @media (max-width: 800px) {
            .main-content { flex-direction: column; }
            .info-section { min-width: unset; flex: unset; }
            .simulation-container { height: 98%; padding: 1rem; }
            h1 { font-size: 1.2rem; }
        }
    </style>
</head>
<body>

<div class="simulation-container">
    <h1>Simulación: Trazabilidad de Producto con Mapa Interactivo</h1>
    
    <div class="main-content">
        <div id="map"></div>
        <div class="info-section">
            <div class="info-card">
                <h3>Información del Envío</h3>
                <div class="info-item"><label>Estado:</label><span id="current-status">En espera</span></div>
                <div class="info-item"><label>Temp. Carga:</label><span id="temperature">--°C</span></div>
                <div class="info-item"><label>Tiempo Trans.:</label><span id="elapsed-time">00:00:00</span></div>
                <div class="info-item"><label>ETA:</label><span id="eta">--:--:--</span></div>
            </div>
            <div class="info-card status-history">
                <h3>Historial de Trazabilidad</h3>
                <div id="status-log"></div>
            </div>
        </div>
    </div>

    <div class="controls">
        <button id="start-btn">▶ Iniciar</button>
        <button id="stop-btn">❚❚ Detener</button>
        <button id="reset-btn">↺ Reiniciar</button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const ui = {
        status: document.getElementById('current-status'),
        temp: document.getElementById('temperature'),
        elapsed: document.getElementById('elapsed-time'),
        eta: document.getElementById('eta'),
        log: document.getElementById('status-log'),
        startBtn: document.getElementById('start-btn'),
        stopBtn: document.getElementById('stop-btn'),
        resetBtn: document.getElementById('reset-btn'),
    };

    const routePoints = [
        { lat: 4.813, lng: -74.343, label: 'Finca (Tabio)' },
        { lat: 4.711, lng: -74.072, label: 'Centro Acopio (Bogotá)' },
        { lat: 4.630, lng: -74.084, label: 'Centro Distribución' },
        { lat: 3.451, lng: -76.532, label: 'Almacén Regional (Cali)' },
        { lat: 2.444, lng: -76.614, label: 'Destino Final (Popayán)' }
    ];
    
    // ---- MODIFICACIÓN 1: Duración total de 3 minutos (180,000 ms) ----
    const segmentDurations = [28125, 22500, 84375, 45000]; 
    const totalDuration = segmentDurations.reduce(function(a, b) { return a + b; }, 0);

    let state = {
        map: null,
        isRunning: false,
        startTime: 0,
        pauseTime: 0,
        totalPausedTime: 0,
        animationFrameId: null,
        currentTemp: 5.0,
        layers: {
            route: null,
            progress: null,
            nodes: [],
            truck: null
        }
    };

    const formatTime = function(ms) { return new Date(ms).toISOString().substr(11, 8); };
    const interpolate = function(p1, p2, t) { return { lat: p1.lat + (p2.lat - p1.lat) * t, lng: p1.lng + (p2.lng - p1.lng) * t }; };

    function initializeMap() {
        state.map = L.map('map');
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(state.map);
        
        const bounds = L.latLngBounds(routePoints.map(function(p) { return [p.lat, p.lng]; }));
        state.map.fitBounds(bounds, { padding: [50, 50] });
    }

    function initializeRoute() {
        Object.values(state.layers).forEach(function(layer) {
            if (Array.isArray(layer)) {
                layer.forEach(function(subLayer) { if(subLayer) state.map.removeLayer(subLayer); });
            } else if (layer) {
                state.map.removeLayer(layer);
            }
        });
        state.layers = { route: null, progress: null, nodes: [], truck: null };

        state.layers.route = L.polyline(routePoints, { color: 'var(--inactive-color)', weight: 5, opacity: 0.7 }).addTo(state.map);
        state.layers.progress = L.polyline([], { color: 'var(--completed-color)', weight: 5 }).addTo(state.map);

        routePoints.forEach(function(point, i) {
            const node = L.circleMarker([point.lat, point.lng], {
                radius: 8, fillColor: 'var(--inactive-color)', color: '#FFF', weight: 2, fillOpacity: 1
            }).bindPopup(point.label).addTo(state.map);
            state.layers.nodes.push(node);
        });

        const truckIcon = L.divIcon({ className: 'truck-icon', iconSize: [32, 32], iconAnchor: [16, 16] });
        state.layers.truck = L.marker(routePoints[0], { icon: truckIcon }).addTo(state.map);
    }
    
    function animate(timestamp) {
        if (!state.isRunning) return;
        const elapsed = timestamp - state.startTime - state.totalPausedTime;

        if (elapsed >= totalDuration) {
            update(totalDuration);
            stopSimulation();
            ui.status.textContent = "Entregado";
            return;
        }
        update(elapsed);
        state.animationFrameId = requestAnimationFrame(animate);
    }

    function update(elapsed) {
        let cumulativeDuration = 0;
        let currentSegment = -1;
        for (let i = 0; i < segmentDurations.length; i++) {
            if (elapsed < cumulativeDuration + segmentDurations[i]) {
                currentSegment = i;
                break;
            }
            cumulativeDuration += segmentDurations[i];
        }
        
        const segmentProgress = (elapsed - cumulativeDuration) / segmentDurations[currentSegment];
        const startPoint = routePoints[currentSegment];
        const endPoint = routePoints[currentSegment + 1];

        const currentPos = interpolate(startPoint, endPoint, segmentProgress);
        state.layers.truck.setLatLng(currentPos);

        // ---- MODIFICACIÓN 2: Se eliminó la rotación del camión ----
        // const bearing = getBearing(startPoint, endPoint);
        // state.layers.truck.getElement().style.transform += ' rotate(' + bearing + 'deg)';

        const progressPath = routePoints.slice(0, currentSegment + 1).map(function(p) { return [p.lat, p.lng]; });
        progressPath.push([currentPos.lat, currentPos.lng]);
        state.layers.progress.setLatLngs(progressPath);

        state.layers.nodes.forEach(function(node, i) {
            const statusIcon = document.getElementById('status-icon-' + i);
            if (i <= currentSegment) {
                node.setStyle({ fillColor: 'var(--completed-color)' });
                if (statusIcon && !statusIcon.classList.contains('completed')) {
                    statusIcon.classList.remove('active');
                    statusIcon.classList.add('completed');
                }
            } else if (i === currentSegment + 1) {
                node.setStyle({ fillColor: 'var(--active-color)' });
                 if (statusIcon && !statusIcon.classList.contains('active')) {
                    statusIcon.classList.add('active');
                 }
            }
        });
        
        simulateTemperature();
        ui.status.textContent = 'En tránsito a ' + endPoint.label;
        ui.temp.textContent = state.currentTemp.toFixed(1) + '°C';
        ui.elapsed.textContent = formatTime(elapsed);
        ui.eta.textContent = formatTime(totalDuration - elapsed);
    }
    
    function simulateTemperature() {
        state.currentTemp += (Math.random() - 0.5) * 0.2;
        if (state.currentTemp > 7.0) state.currentTemp = 7.0;
        if (state.currentTemp < 2.0) state.currentTemp = 2.0;
    }
    
    function startSimulation() {
        if (state.isRunning) return;
        state.isRunning = true;
        if (state.startTime === 0) {
            state.startTime = performance.now();
            generateStatusLog();
        } else {
            state.totalPausedTime += performance.now() - state.pauseTime;
        }
        requestAnimationFrame(animate);
    }

    function stopSimulation() {
        if (!state.isRunning) return;
        state.isRunning = false;
        state.pauseTime = performance.now();
        cancelAnimationFrame(state.animationFrameId);
    }

    function resetSimulation() {
        stopSimulation();
        state.startTime = 0;
        state.totalPausedTime = 0;
        state.currentTemp = 5.0;
        ui.log.innerHTML = '';
        ui.status.textContent = 'En espera';
        ui.temp.textContent = '--°C';
        ui.elapsed.textContent = '00:00:00';
        ui.eta.textContent = '--:--:--';
        initializeRoute();
    }
    
    function generateStatusLog() {
        ui.log.innerHTML = '';
        routePoints.forEach(function(point, i) {
            const status = i === 0 ? 'Origen' : (i === routePoints.length -1 ? 'Destino' : 'Punto de control');
            ui.log.innerHTML += 
                '<div class="status-item">' +
                    '<div class="status-icon" id="status-icon-' + i + '"></div>' +
                    '<div class="status-details">' +
                        '<p>' + point.label + '</p>' +
                        '<small>Estado: ' + status + '</small>' +
                    '</div>' +
                '</div>';
        });
        document.getElementById('status-icon-0').classList.add('active');
    }

    initializeMap();
    initializeRoute();
    ui.startBtn.addEventListener('click', startSimulation);
    ui.stopBtn.addEventListener('click', stopSimulation);
    ui.resetBtn.addEventListener('click', resetSimulation);
});
</script>

</body>
</html>